---
title: "Plotting variable importance"
author: "Wesley Rancher"
date: "2025-07-01"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r}
library(pdp)
library(tidymodels)
library(randomForest)
library(vip)
```

Model fits obtained from model_fitting.Rmd

```{r}
model_files <- list.files("models/", full.names = TRUE)

models <- setNames(
  lapply(model_files, readRDS),
  tools::file_path_sans_ext(basename(model_files))
)
```

Partial dependence on most important variables

```{r}
#iterate over each model and plot partial dependence
pdp_lines <- list()

for (spp in names(models)) {
  model <- models[[spp]]
  fit <- extract_fit_parsnip(model)
  recipe <- extract_recipe(model)
  
  #cleaned predictor variables
  training_data <- training_df_imputed %>% filter(Species == gsub("final_fit_", "", spp) %>% gsub("_", " ", .))
  predictors <- bake(recipe, new_data = training_data) %>% as.data.frame()#apply tidymodel preprocessing steps
  
  #variable importance
  vip <- vi(fit)
  
  #partial dependence results
  pdp_res <- pdp::partial(
    object = fit$fit,
    pred.var = "tcb_summer",
    train = predictors,
    type = "regression"
  )
  
  pdp_res$Species <- gsub("final_fit_", "", spp) %>% gsub("_", " ", .)
  pdp_lines[[spp]] <- pdp_res
}

pdp_df <- bind_rows(pdp_lines)
```

Plotting variable importance and partial dependence

```{r}
#visualize
ggplot(pdp_df, aes(x = tcb_summer, y = yhat, color = Species)) +
  geom_line(size = 1) +
  facet_grid(Species~.)+
  labs(
    x = "Summer Tasseled Cap Brightness (Normalized)",
    y = "Predicted Biomass (g/mÂ²)"
  ) +
  theme_bw(base_family = "Times New Roman")
```

