---
title: "Plotting prediction accuracies"
author: "Wesley Rancher"
date: "2025-07-01"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r}
library(tidymodels)
library(ggplot2)
library(viridis)
library(patchwork)
```

Model fits obtained from model_fitting.Rmd

```{r}
model_files <- list.files("models/", full.names = TRUE)

#read in RDS object and set names
models <- setNames(
  lapply(model_files, readRDS),
  tools::file_path_sans_ext(basename(model_files))
)
```

Validation/ testing sets

```{r}
training_df_all_spp <- read.csv("data/processed/csv/training_df_imputed.csv")

# iterable list
species <- c("black spruce", "white spruce", "resin birch", "quaking aspen")
display_names <- c("Black spruce", "White spruce", "Alaskan birch", "Trembling aspen")
names(display_names) <- species

plot_dfs <- list()
for (spp in species){
  df <- training_df_all_spp %>% filter(Species == spp)
  split_data <- initial_split(df, prop = 0.70, strata = all_of("Biogm2"))
  validation_df <- testing(split_data)
  
  #select model and predict
  model <- models[[paste0("final_fit_", gsub(" ", "_", spp))]]
  prediction <- predict(model, validation_df)
  observed <- validation_df$Biogm2
  prediction_vals <- prediction[[1]]
  
  #rbind
  plot_df <- rbind(data.frame(Observed=observed, Predicted=prediction_vals, Species=display_names[[spp]]))
  plot_dfs[[spp]] <- plot_df
}

#bind the dataframes
main_plot_df <- do.call(rbind, plot_dfs)
```

Visualize

```{r}
#factor the species
main_plot_df <- main_plot_df %>%
  mutate(Species = factor(Species, levels = c("Black spruce", "White spruce", "Alaskan birch", "Trembling aspen")))
#plot
validation_plot <- ggplot(main_plot_df, aes(x = Predicted, y = Observed, color = abs(Observed-Predicted))) +
  geom_point(size = 4, alpha = .5, shape = 16) +
  geom_smooth(method = "lm", color = "black", linetype = "solid", se = FALSE)+
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  scale_color_viridis(option = "viridis", direction=1)+
  facet_wrap(~Species) +
  theme_bw(base_family = "Times New Roman") +
  scale_x_continuous(limits=c(0,2000))+
  scale_y_continuous(limits=c(0,2000))+
  labs(x = "Biomass Predicted (g/m²)", 
       y = "Biomass Observed (g/m²)", 
       color = "Difference (g/m²)") +
  theme(axis.text = element_text(color = "black", size = 14),
        axis.text.x = element_text(color = "black", size = 14),
        plot.title = element_text(color = "black", size = 20),
        axis.title.y = element_text(color = "black", size = 18),
        axis.title.x = element_text(color = "black", size = 18, vjust = -.25),
        strip.text = element_text(color = "black", size = 13),
        legend.position = "inside",
        legend.position.inside = c(0.9, 0.125),
        legend.background = element_blank(),
        legend.frame = element_rect(color="black"),
        legend.box.background = element_rect(),
        legend.key.size = unit(0.4, "cm"),
        legend.title = element_text(size = 10),
        legend.spacing = unit(0.2, "cm"),
        legend.text = element_text(color = "black", size = 10),
        panel.grid.major = element_line(color = "gray70", linewidth = .25),
        panel.grid.minor = element_blank())
validation_plot
```

```{r}
png("results/graphs/model_accuracy.png", width = 7, height = 6, units = "in", res = 300)
print(validation_plot)
dev.off()
```
